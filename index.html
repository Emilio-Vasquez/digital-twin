<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Digital Twin Simulator</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="banner" role="note" aria-label="Simulation disclaimer">
    <span class="banner-dot" aria-hidden="true"></span>
    <span><strong>This is a simulation.</strong> No real data is collected or stored.</span>
  </div>

  <header class="hero">
    <div class="hero-inner">
      <div class="hero-top">
        <div>
          <h1>Your Digital Twin Already Exists</h1>
          <p class="sub">
            This site turns a few everyday “signals” into a fictional <span class="hl">twin card</span> — a persona a system might generate.
            Change one input and watch the twin adapt.
          </p>
        </div>
        <div class="hero-chip" aria-label="Workshop mode">
          <span class="chip-dot" aria-hidden="true"></span>
          Workshop Demo
        </div>
      </div>

      <div class="hero-actions">
        <button class="btn" type="button" id="presetPrivate">Private Mode</button>
        <button class="btn" type="button" id="presetSocial">Social & Connected</button>
        <button class="btn" type="button" id="presetLate">Late-Night Scroll</button>
        <button class="btn ghost" type="button" id="reset">Reset</button>
      </div>

      <p class="mini">
        Tip: pick a preset, then change <strong>one</strong> thing and compare with a friend.
      </p>
    </div>
  </header>

  <main class="wrap">
    <section class="panel">
      <div class="panel-head">
        <h2>1) Build Your Twin</h2>
        <p class="muted">These are the only inputs. Everything else is generated.</p>
      </div>

      <form id="twinForm" class="form" autocomplete="off">
        <div class="grid2">
          <div class="field">
            <label for="ageRange">Age range</label>
            <select id="ageRange" name="ageRange">
              <option value="u18">Under 18</option>
              <option value="18_24" selected>18–24</option>
              <option value="25_34">25–34</option>
              <option value="35_44">35–44</option>
              <option value="45p">45+</option>
            </select>
          </div>

          <div class="field">
            <label for="majorInterest">Major interest</label>
            <select id="majorInterest" name="majorInterest">
              <option value="cyber" selected>Cybersecurity</option>
              <option value="data">Data Science</option>
              <option value="gaming">Gaming</option>
              <option value="music">Music</option>
              <option value="fitness">Fitness</option>
              <option value="design">Art & Design</option>
              <option value="business">Business</option>
              <option value="travel">Travel</option>
            </select>
          </div>
        </div>

        <div class="field">
          <div class="row">
            <label for="socialUse">Social media use</label>
            <span class="pill" id="socialValue">5/10</span>
          </div>
          <input type="range" id="socialUse" name="socialUse" min="0" max="10" value="5" />
          <div class="hint"><span>Low</span><span>High</span></div>
        </div>

        <div class="grid2">
          <div class="field">
            <div class="row">
              <label for="locationSharing">Location sharing</label>
              <label class="switch">
                <input type="checkbox" id="locationSharing" name="locationSharing" />
                <span class="slider" aria-hidden="true"></span>
              </label>
            </div>
            <p class="muted small">Adds context (nearby events, local suggestions).</p>
          </div>

          <div class="field">
            <div class="row">
              <label for="lateNight">Late-night activity</label>
              <label class="switch">
                <input type="checkbox" id="lateNight" name="lateNight" />
                <span class="slider" aria-hidden="true"></span>
              </label>
            </div>
            <p class="muted small">Adds a behavioral pattern signal.</p>
          </div>
        </div>

        <fieldset class="field">
          <legend>Password habits</legend>
          <div class="radio3">
            <label class="radio">
              <input type="radio" name="passwordHabits" value="strong" checked />
              <span>Strong</span>
              <em>Unique + MFA</em>
            </label>
            <label class="radio">
              <input type="radio" name="passwordHabits" value="okay" />
              <span>Okay</span>
              <em>Some reuse</em>
            </label>
            <label class="radio">
              <input type="radio" name="passwordHabits" value="risky" />
              <span>Risky</span>
              <em>Reuse/shared</em>
            </label>
          </div>
        </fieldset>

        <fieldset class="field">
          <legend>Device usage</legend>
          <div class="checks">
            <label class="check"><input type="checkbox" name="devices" value="phone" checked /> <span>Phone</span></label>
            <label class="check"><input type="checkbox" name="devices" value="laptop" checked /> <span>Laptop</span></label>
            <label class="check"><input type="checkbox" name="devices" value="tablet" /> <span>Tablet</span></label>
            <label class="check"><input type="checkbox" name="devices" value="watch" /> <span>Smartwatch</span></label>
            <label class="check"><input type="checkbox" name="devices" value="console" /> <span>Gaming console</span></label>
          </div>
        </fieldset>
      </form>
    </section>

    <section class="panel">
      <div class="panel-head">
        <h2>2) Algorithmic Output</h2>
        <p class="muted">Friendly feedback that updates live.</p>
      </div>

      <div class="kpis">
        <div class="kpi">
          <div class="kpi-top"><span>Ad Profile</span></div>
          <div class="kpi-val" id="adProfile">—</div>
          <div class="kpi-sub muted" id="adProfileWhy"></div>
        </div>

        <div class="kpi">
          <div class="kpi-top">
            <span>Security Risk</span>
            <span class="badge" id="riskBadge">—</span>
          </div>
          <div class="kpi-val"><span id="riskScore">—</span><span class="unit">/100</span></div>
          <div class="kpi-sub muted" id="riskWhy"></div>
        </div>

        <div class="kpi">
          <div class="kpi-top">
            <span>Targeting Confidence</span>
            <span class="badge" id="confidenceBadge">—</span>
          </div>
          <div class="kpi-val"><span id="targetConfidence">—</span><span class="unit">%</span></div>
          <div class="kpi-sub muted" id="confidenceWhy"></div>
        </div>
      </div>

      <div class="split">
        <div class="box">
          <div class="box-head">
            <h3>Likely Interests</h3>
            <span class="muted small">(generated)</span>
          </div>
          <div class="chips" id="likelyInterests"></div>
        </div>

        <div class="box">
          <div class="box-head">
            <h3>Recommended Actions</h3>
            <span class="muted small">(safe + friendly)</span>
          </div>
          <ul class="list" id="recommendedActions"></ul>
        </div>
      </div>

      <div class="explain" id="changeExplain">Try a preset, then change one thing and compare.</div>

      <div class="goals">
        <div class="goals-head">
          <strong>Mini goals</strong>
          <span class="muted small">Quick challenges to make it feel like a game.</span>
        </div>
        <div class="goal-list" id="goalList"></div>
      </div>
    </section>

    <section class="panel">
      <div class="panel-head">
        <h2>3) Twin Card</h2>
        <p class="muted">AI-generated persona based on the current signals. No scary language.</p>
      </div>

      <div class="twin">
        <div class="twin-top">
          <div class="twin-id">
            <div class="muted small">Twin ID</div>
            <div class="mono" id="twinId">—</div>
          </div>

          <div class="twin-meta">
            <div class="meta">
              <div class="muted small">Mirroring Strength</div>
              <div class="badge" id="twinStrengthBadge">—</div>
            </div>
            <div class="meta">
              <div class="muted small">Recreation Likelihood</div>
              <div class="badge" id="twinLikelihoodBadge">—</div>
            </div>
          </div>

          <div class="twin-cta">
            <button class="btn primary" type="button" id="regenPersona">Regenerate</button>
          </div>
        </div>

        <div class="twin-main">
          <div class="ai">
            <div class="ai-head">
              <h3>AI Persona</h3>
              <div class="status" id="aiStatus">Ready</div>
            </div>
            <div class="ai-body" id="aiPersona">
              <p class="muted">As you change inputs, this persona updates automatically.</p>
            </div>
            <div class="ai-foot muted small" id="aiMeta"></div>
          </div>

          <div class="side">
            <div class="side-block">
              <div class="side-head">
                <h3>Signal Map</h3>
                <span class="muted small">Top signals used</span>
              </div>
              <ul class="list" id="twinSignals"></ul>
            </div>

            <div class="side-block">
              <div class="side-head">
                <h3>Used For</h3>
                <span class="muted small">Typical system uses</span>
              </div>
              <div class="chips" id="twinUseCases"></div>
            </div>

            <div class="note muted small">
              Friendly note: this isn’t “someone knows you.” It’s about how consistently a system can guess patterns from signals.
            </div>
          </div>
        </div>
      </div>

      <details class="debug">
        <summary>Show request payload (for instructors)</summary>
        <pre id="payloadPreview"></pre>
      </details>
    </section>
  </main>

  <footer class="foot">
    <div class="foot-inner muted small">
      Built for workshops • Client-side simulation + secure backend proxy for AI generation.
    </div>
  </footer>

  <script src="script.js"></script>
</body>
<script src="script.js">
  /*
  Digital Twin v3
  - Static frontend (GitHub Pages)
  - Secure backend proxy (Cloudflare Worker) to call OpenAI
  - AI Persona is the Twin Card (always included)
*/

// === CONFIG ===
// Set this to your deployed Worker URL, e.g. "https://digital-twin-api.<your>.workers.dev"
// If left blank, the app will call same-origin "/api/twin" (useful for local testing with a dev server).
const API_BASE_URL = "";

// Placeholder requested by user (NOT USED by default, for safety):
// Do NOT put a real key in GitHub Pages.
const OPENAI_API_KEY_PLACEHOLDER = "THISISMYAPI";

const els = {
  form: document.getElementById("twinForm"),
  ageRange: document.getElementById("ageRange"),
  majorInterest: document.getElementById("majorInterest"),
  socialUse: document.getElementById("socialUse"),
  socialValue: document.getElementById("socialValue"),
  locationSharing: document.getElementById("locationSharing"),
  lateNight: document.getElementById("lateNight"),

  presetPrivate: document.getElementById("presetPrivate"),
  presetSocial: document.getElementById("presetSocial"),
  presetLate: document.getElementById("presetLate"),
  reset: document.getElementById("reset"),

  adProfile: document.getElementById("adProfile"),
  adProfileWhy: document.getElementById("adProfileWhy"),
  riskScore: document.getElementById("riskScore"),
  riskBadge: document.getElementById("riskBadge"),
  riskWhy: document.getElementById("riskWhy"),
  targetConfidence: document.getElementById("targetConfidence"),
  confidenceBadge: document.getElementById("confidenceBadge"),
  confidenceWhy: document.getElementById("confidenceWhy"),
  likelyInterests: document.getElementById("likelyInterests"),
  recommendedActions: document.getElementById("recommendedActions"),
  changeExplain: document.getElementById("changeExplain"),
  goalList: document.getElementById("goalList"),

  // Twin card
  twinId: document.getElementById("twinId"),
  twinStrengthBadge: document.getElementById("twinStrengthBadge"),
  twinLikelihoodBadge: document.getElementById("twinLikelihoodBadge"),
  twinSignals: document.getElementById("twinSignals"),
  twinUseCases: document.getElementById("twinUseCases"),
  aiPersona: document.getElementById("aiPersona"),
  aiStatus: document.getElementById("aiStatus"),
  aiMeta: document.getElementById("aiMeta"),
  regenPersona: document.getElementById("regenPersona"),
  payloadPreview: document.getElementById("payloadPreview"),
};

function clamp(n, min, max) {
  return Math.max(min, Math.min(max, n));
}

function badgeLevel(value, lowMax, medMax) {
  if (value <= lowMax) return { label: "Low", cls: "low" };
  if (value <= medMax) return { label: "Medium", cls: "medium" };
  return { label: "High", cls: "high" };
}

function setBadge(el, level) {
  el.classList.remove("low", "medium", "high");
  el.classList.add(level.cls);
  el.textContent = level.label;
}

function getPasswordHabit() {
  const checked = els.form.querySelector('input[name="passwordHabits"]:checked');
  return checked ? checked.value : "strong";
}

function setPasswordHabit(value) {
  const radio = els.form.querySelector(`input[name="passwordHabits"][value="${value}"]`);
  if (radio) radio.checked = true;
}

function getDevices() {
  return Array.from(els.form.querySelectorAll('input[name="devices"]:checked')).map((x) => x.value);
}

function setDevices(values) {
  const set = new Set(values);
  els.form.querySelectorAll('input[name="devices"]').forEach((cb) => {
    cb.checked = set.has(cb.value);
  });
}

function randomTwinId() {
  const alphabet = "ABCDEFGHJKMNPQRSTUVWXYZ23456789";
  const pick = (n) => {
    let out = "";
    if (window.crypto && window.crypto.getRandomValues) {
      const buf = new Uint8Array(n);
      window.crypto.getRandomValues(buf);
      for (let i = 0; i < n; i++) out += alphabet[buf[i] % alphabet.length];
      return out;
    }
    for (let i = 0; i < n; i++) out += alphabet[Math.floor(Math.random() * alphabet.length)];
    return out;
  };
  return `DT-${pick(6)}`;
}

const SESSION_TWIN_ID = randomTwinId();
els.twinId.textContent = SESSION_TWIN_ID;

function interestLabel(key) {
  return (
    {
      cyber: "Cybersecurity",
      data: "Data Science",
      gaming: "Gaming",
      music: "Music",
      fitness: "Fitness",
      design: "Art & Design",
      business: "Business",
      travel: "Travel",
    }[key] || "General"
  );
}

function ageLabel(key) {
  return (
    {
      u18: "Under 18",
      "18_24": "18–24",
      "25_34": "25–34",
      "35_44": "35–44",
      "45p": "45+",
    }[key] || "Unknown"
  );
}

// === Core scoring (simple + explainable) ===
function computeRisk({ age, interest, social, location, password, devices, lateNight }) {
  const passwordPoints = { strong: 10, okay: 35, risky: 70 }[password] ?? 10;
  const agePoints = { u18: 6, "18_24": 10, "25_34": 12, "35_44": 10, "45p": 8 }[age] ?? 10;
  const socialPoints = social * 2; // 0..20
  const locationPoints = location ? 15 : 0;
  const lateNightPoints = lateNight ? 10 : 0;

  const devicePointsMap = { phone: 5, laptop: 3, tablet: 2, watch: 2, console: 3 };
  const devicePoints = devices.reduce((sum, d) => sum + (devicePointsMap[d] || 0), 0);

  const interestFlavor = ["cyber", "data"].includes(interest) ? -2 : 2;

  const raw = passwordPoints + agePoints + socialPoints + locationPoints + lateNightPoints + devicePoints + interestFlavor;
  return clamp(Math.round(raw), 0, 100);
}

function computeConfidence({ social, location, devices, lateNight }) {
  const deviceCount = devices.length;
  let raw = 35 + social * 4 + deviceCount * 6 + (location ? 10 : 0) + (lateNight ? 5 : 0);
  return clamp(Math.round(raw), 25, 95);
}

function pickAdProfile({ interest, social, devices, lateNight, location }) {
  const manySignals = devices.length >= 3 || social >= 7 || location;
  const map = {
    cyber: ["Security Scout", "Privacy-Pro Planner", "System Sleuth"],
    data: ["Insight Seeker", "Dashboard Devotee", "Pattern Hunter"],
    gaming: ["Cozy Gamer", "Hype Gamer", "Competitive Grinder"],
    music: ["Playlist Curator", "Concert Chaser", "New-Release Radar"],
    fitness: ["Goal Getter", "Routine Builder", "Tracker Fan"],
    design: ["Visual Explorer", "Creative Collector", "Aesthetic Architect"],
    business: ["Career Climber", "Deal Strategist", "Startup Watcher"],
    travel: ["Local Explorer", "Weekend Wanderer", "Deal Finder"],
  };
  const options = map[interest] || ["Curious Explorer", "Tech Taster", "Trend Tester"];
  if (lateNight && social >= 6) return options[1];
  if (manySignals) return options[2] || options[0];
  return options[0];
}

function adProfileWhyText({ social, location, devices, lateNight }) {
  const bits = [];
  if (social >= 7) bits.push("high social activity");
  if (location) bits.push("location signals");
  if (devices.length >= 3) bits.push("multiple devices");
  if (lateNight) bits.push("late-night pattern");
  if (bits.length === 0) return "Light signals → broader profile.";
  return `Signals like ${bits.slice(0, 2).join(" + ")} make the profile more specific.`;
}

function buildLikelyInterests({ interest, social, devices, lateNight, location }) {
  const base =
    {
      cyber: ["Password tools", "Privacy settings", "Security tips"],
      data: ["AI & analytics", "Cool dashboards", "Data storytelling"],
      gaming: ["Game drops", "Streaming", "Headsets & gear"],
      music: ["New releases", "Playlists", "Live shows"],
      fitness: ["Training plans", "Wearables", "Meal ideas"],
      design: ["Creative tools", "Inspiration boards", "Design trends"],
      business: ["Career growth", "Productivity", "Side hustles"],
      travel: ["Weekend plans", "Budget deals", "Local spots"],
    }[interest] || ["Trends", "Communities", "Recommendations"];

  const list = [...base];
  if (social >= 7) list.push("Creators & trends");
  if (location) list.push("Nearby events");
  if (devices.includes("console")) list.push("Gaming content");
  if (devices.includes("watch")) list.push("Health tracking");
  if (lateNight) list.push("Late-night browsing");

  return Array.from(new Set(list)).slice(0, 5);
}

function renderChips(containerEl, chips) {
  containerEl.innerHTML = "";
  chips.forEach((t) => {
    const span = document.createElement("span");
    span.className = "chip";
    span.textContent = t;
    containerEl.appendChild(span);
  });
}

function renderList(containerEl, items) {
  containerEl.innerHTML = "";
  items.forEach((t) => {
    const li = document.createElement("li");
    li.textContent = t;
    containerEl.appendChild(li);
  });
}

function riskWhyText({ password, location, social }) {
  const pieces = [];
  if (password === "risky") pieces.push("password reuse is a strong risk signal");
  if (location) pieces.push("always-on location adds exposure");
  if (social >= 7) pieces.push("high activity creates more surface area");
  if (pieces.length === 0) return "Looks fairly low-risk based on selected habits.";
  return `Main drivers: ${pieces.slice(0, 2).join(" + ")}.`;
}

function confidenceWhyText({ social, location, devices }) {
  const pieces = [];
  if (devices.length >= 3) pieces.push("more devices = more signals");
  if (social >= 6) pieces.push("more activity = clearer pattern");
  if (location) pieces.push("location adds context");
  if (pieces.length === 0) return "Fewer signals → the system is less confident guessing.";
  return `Why confidence is higher: ${pieces.slice(0, 2).join(" + ")}.`;
}

function smartRecommendedActions(state, riskLabel, confLabel) {
  const actions = [];
  actions.push(state.location ? "Try turning Location Sharing OFF and watch what changes." : "Try turning Location Sharing ON and see how confidence shifts.");
  actions.push(state.password !== "strong" ? "Switch Password Habits to “Strong” and see the risk score drop." : "You already have strong passwords — try changing a different signal.");
  actions.push(state.social >= 7 ? "Lower Social Media Use a bit and see if the profile becomes less specific." : "Increase Social Media Use to see confidence climb (more signals).");
  actions.push(`Right now: Risk is ${riskLabel} and confidence is ${confLabel}. Try to keep confidence high while lowering risk.`);
  return actions.slice(0, 4);
}

function renderGoals(state, riskLabel, confLabel) {
  const goals = [];
  goals.push(
    riskLabel !== "Low"
      ? { title: "Goal: Drop risk one level", body: "Move Security Risk down without changing Device Usage." }
      : { title: "Goal: Keep risk Low", body: "Increase Social Media Use while keeping Security Risk Low." }
  );

  goals.push(
    confLabel !== "High"
      ? { title: "Goal: Raise confidence", body: "Get Targeting Confidence to High while keeping Location Sharing OFF." }
      : { title: "Goal: Reduce signals", body: "Turn off 1–2 signals and see how confidence reacts." }
  );

  goals.push({ title: "Goal: Flip the Ad Profile", body: "Change only ONE setting and make the Ad Profile switch." });

  els.goalList.innerHTML = "";
  goals.slice(0, 3).forEach((g) => {
    const div = document.createElement("div");
    div.className = "goal";
    div.innerHTML = `<strong>${g.title}</strong><p>${g.body}</p>`;
    els.goalList.appendChild(div);
  });
}

function computeTwinStrengthScore(state, confidence) {
  const deviceCount = state.devices.length;
  const signalScore = confidence * 0.55 + state.social * 5 + deviceCount * 8 + (state.location ? 10 : 0) + (state.lateNight ? 6 : 0);
  return clamp(Math.round(signalScore), 0, 100);
}

function strengthLabel(score) {
  if (score <= 39) return { label: "Loose", cls: "low" };
  if (score <= 69) return { label: "Moderate", cls: "medium" };
  return { label: "Strong", cls: "high" };
}

function likelihoodLabel(score) {
  if (score <= 39) return { label: "Low", cls: "low" };
  if (score <= 69) return { label: "Medium", cls: "medium" };
  return { label: "High", cls: "high" };
}

function signalMapLines(state) {
  const deviceCount = state.devices.length;
  const socialLine = state.social >= 7 ? `Social media: High (${state.social}/10)` : state.social >= 4 ? `Social media: Medium (${state.social}/10)` : `Social media: Low (${state.social}/10)`;
  const locLine = `Location sharing: ${state.location ? "ON (adds context)" : "OFF"}`;
  const nightLine = `Late-night activity: ${state.lateNight ? "ON (pattern signal)" : "OFF"}`;
  const passLine = state.password === "strong" ? "Password habits: Strong (unique + MFA)" : state.password === "okay" ? "Password habits: Okay (some reuse)" : "Password habits: Risky (reuse/shared)";
  const devLine = `Device streams: ${deviceCount} (${state.devices.join(", ") || "none"})`;
  return [socialLine, locLine, passLine, devLine, nightLine];
}

function twinUseCases(state, confidence, risk) {
  const use = ["Personalized recommendations", "Ad targeting segments"];
  if (confidence >= 70) use.push("Trend prediction (what you’ll click)");
  if (state.location) use.push("Local suggestions (events/places)");
  use.push(risk >= 66 ? "Security prompts & extra verification" : "Account safety nudges");
  return Array.from(new Set(use)).slice(0, 5);
}

// === Explain changes ===
let prevSnap = null;
function stateSnap(state) {
  return {
    age: state.age,
    interest: state.interest,
    social: state.social,
    location: state.location,
    lateNight: state.lateNight,
    password: state.password,
    devices: state.devices.slice().sort().join(","),
  };
}

function diffExplain(a, b) {
  if (!a || !b) return "Try a preset, then change one thing and compare.";
  const changes = [];
  if (a.social !== b.social) changes.push(`social → ${b.social}/10`);
  if (a.location !== b.location) changes.push(`location → ${b.location ? "ON" : "OFF"}`);
  if (a.lateNight !== b.lateNight) changes.push(`late-night → ${b.lateNight ? "ON" : "OFF"}`);
  if (a.password !== b.password) changes.push(`password → ${b.password}`);
  if (a.devices !== b.devices) changes.push(`devices → updated`);
  if (a.age !== b.age) changes.push(`age → updated`);
  if (a.interest !== b.interest) changes.push(`interest → updated`);
  if (!changes.length) return "Try a preset, then change one thing and compare.";
  return `You changed: ${changes.slice(0, 2).join(" • ")}.`;
}

// === AI Persona generation ===
let latestPayload = null;
let latestDerived = null;
let debounceTimer = null;
let inflight = 0;

function setStatus(text) {
  els.aiStatus.textContent = text;
}

function apiUrl(path) {
  return (API_BASE_URL ? API_BASE_URL.replace(/\/$/, "") : "") + path;
}

async function fetchPersona(payload) {
  const reqId = ++inflight;
  setStatus("Generating…");

  try {
    const res = await fetch(apiUrl("/api/twin"), {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    if (!res.ok) {
      const txt = await res.text();
      throw new Error(`Backend error (${res.status}): ${txt}`);
    }

    const data = await res.json();

    // Only apply if this is the latest request
    if (reqId !== inflight) return;

    // Render persona
    const html = (data.persona_html || "").trim();
    const text = (data.persona_text || "").trim();

    els.aiPersona.innerHTML = html ? html : `<p>${escapeHtml(text || "(No persona returned.)")}</p>`;
    setStatus("Updated");

    const now = new Date();
    els.aiMeta.textContent = `Updated: ${now.toLocaleTimeString()} • Model: ${data.model || "(unknown)"}`;
  } catch (err) {
    if (reqId !== inflight) return;
    setStatus("Offline");
    els.aiPersona.innerHTML = `<p class="muted"><strong>AI persona unavailable.</strong> Connect the secure backend, then try again.</p>
      <p class="muted small">${escapeHtml(String(err.message || err))}</p>`;
    els.aiMeta.textContent = "";
  }
}

function escapeHtml(s) {
  return String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function schedulePersona(force = false) {
  if (!latestPayload) return;

  // Debounce to avoid spamming the backend
  const delay = force ? 0 : 900;
  if (debounceTimer) clearTimeout(debounceTimer);
  debounceTimer = setTimeout(() => fetchPersona(latestPayload), delay);
}

// === Update loop ===
function updateAll(withExplain = true) {
  const state = {
    age: els.ageRange.value,
    interest: els.majorInterest.value,
    social: Number(els.socialUse.value),
    location: els.locationSharing.checked,
    lateNight: els.lateNight.checked,
    password: getPasswordHabit(),
    devices: getDevices(),
  };

  els.socialValue.textContent = `${state.social}/10`;

  const risk = computeRisk(state);
  const confidence = computeConfidence(state);
  const adProfile = pickAdProfile(state);
  const interests = buildLikelyInterests(state);

  const riskLvl = badgeLevel(risk, 34, 65);
  const confLvl = badgeLevel(confidence, 44, 75);

  setBadge(els.riskBadge, riskLvl);
  setBadge(els.confidenceBadge, confLvl);

  els.riskScore.textContent = risk;
  els.targetConfidence.textContent = confidence;

  els.adProfile.textContent = adProfile;
  els.adProfileWhy.textContent = adProfileWhyText(state);
  els.riskWhy.textContent = riskWhyText(state);
  els.confidenceWhy.textContent = confidenceWhyText(state);

  renderChips(els.likelyInterests, interests);
  renderList(els.recommendedActions, smartRecommendedActions(state, riskLvl.label, confLvl.label));
  renderGoals(state, riskLvl.label, confLvl.label);

  // Twin strength/likelihood + maps
  const strengthScore = computeTwinStrengthScore(state, confidence);
  const strength = strengthLabel(strengthScore);
  const likelihood = likelihoodLabel(strengthScore);
  setBadge(els.twinStrengthBadge, strength);
  setBadge(els.twinLikelihoodBadge, likelihood);

  renderList(els.twinSignals, signalMapLines(state));
  renderChips(els.twinUseCases, twinUseCases(state, confidence, risk));

  // Explain changes
  if (withExplain) {
    const snap = stateSnap(state);
    els.changeExplain.textContent = diffExplain(prevSnap, snap);
    prevSnap = snap;
  }

  // Build AI payload (what the backend uses)
  latestPayload = {
    twin_id: SESSION_TWIN_ID,
    inputs: {
      age_range: ageLabel(state.age),
      major_interest: interestLabel(state.interest),
      social_media_use: state.social,
      location_sharing: state.location,
      password_habits: state.password,
      device_usage: state.devices,
      late_night_activity: state.lateNight,
    },
    outputs: {
      ad_profile: adProfile,
      security_risk_score: risk,
      risk_level: riskLvl.label,
      targeting_confidence: confidence,
      confidence_level: confLvl.label,
      likely_interests: interests,
      recommended_actions: smartRecommendedActions(state, riskLvl.label, confLvl.label),
      mirroring_strength: strength.label,
      recreation_likelihood: likelihood.label,
    },
    style: {
      tone: "friendly",
      audience: "college_students",
      avoid: ["fear", "threats", "guilt"],
      length: "medium",
    },
  };

  latestDerived = { state, risk, confidence, adProfile, interests, riskLvl, confLvl, strength, likelihood };

  // Instructor preview
  els.payloadPreview.textContent = JSON.stringify(latestPayload, null, 2);

  // Auto-update persona
  schedulePersona(false);
}

// === Presets ===
function applyPreset(name) {
  if (name === "private") {
    els.ageRange.value = "18_24";
    els.majorInterest.value = "cyber";
    els.socialUse.value = "2";
    els.locationSharing.checked = false;
    els.lateNight.checked = false;
    setPasswordHabit("strong");
    setDevices(["phone", "laptop"]);
  }

  if (name === "social") {
    els.ageRange.value = "18_24";
    els.majorInterest.value = "music";
    els.socialUse.value = "8";
    els.locationSharing.checked = true;
    els.lateNight.checked = false;
    setPasswordHabit("okay");
    setDevices(["phone", "laptop", "watch"]);
  }

  if (name === "late") {
    els.ageRange.value = "18_24";
    els.majorInterest.value = "gaming";
    els.socialUse.value = "7";
    els.locationSharing.checked = true;
    els.lateNight.checked = true;
    setPasswordHabit("risky");
    setDevices(["phone", "laptop", "console"]);
  }

  updateAll(true);
  schedulePersona(true);
}

function resetAll() {
  els.ageRange.value = "18_24";
  els.majorInterest.value = "cyber";
  els.socialUse.value = "5";
  els.locationSharing.checked = false;
  els.lateNight.checked = false;
  setPasswordHabit("strong");
  setDevices(["phone", "laptop"]);
  updateAll(true);
  schedulePersona(true);
}

els.presetPrivate.addEventListener("click", () => applyPreset("private"));
els.presetSocial.addEventListener("click", () => applyPreset("social"));
els.presetLate.addEventListener("click", () => applyPreset("late"));
els.reset.addEventListener("click", resetAll);
els.regenPersona.addEventListener("click", () => schedulePersona(true));

els.form.addEventListener("input", () => updateAll(true));
els.form.addEventListener("change", () => updateAll(true));

// Init
prevSnap = null;
updateAll(false);
setStatus("Generating…");
schedulePersona(true);

</script>
</html>
